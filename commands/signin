#!/usr/bin/env node
// https://github.com/SeleniumHQ/selenium/tree/selenium-4.26.0/javascript/node/selenium-webdriver#usage
// https://github.com/puppeteer/puppeteer/tree/v18.2.1#usage
const { Builder } = require('selenium-webdriver')
const { writeFile } = require('node:fs/promises')
const { readdir } = require('node:fs/promises')
const { join } = require('node:path')
const readline = require('readline')

async function promptCredentials(providerName) {
  const rl = readline.createInterface({
    input: process.stdin,
    output: process.stdout
  })

  return new Promise((resolve) => {
    rl.question(`Username: `, (username) => {
      // Override _writeToOutput to mask password input
      const originalWriteToOutput = rl._writeToOutput
      rl._writeToOutput = function _writeToOutput(stringToWrite) {
        // Don't mask the prompt or newlines
        if (stringToWrite === '\n' || stringToWrite === '\r\n') {
          rl.output.write(stringToWrite)
        } else if (stringToWrite !== 'Password: ') {
          // Mask password characters
          rl.output.write('*')
        } else {
          rl.output.write(stringToWrite)
        }
      }
      
      rl.question(`Password: `, (password) => {
        rl._writeToOutput = originalWriteToOutput
        rl.output.write('\n')
        rl.close()
        resolve({ username, password })
      })
    })
  })
}

async function saveCredentials(serviceName, username, password) {
  try {
    const keytar = require('keytar')
    await keytar.setPassword(serviceName, username, password)
    console.log('Credentials saved securely.')
  } catch (error) {
    console.warn('Could not save credentials securely:', error.message)
    console.warn('Credentials will not be persisted.')
  }
}

async function loadCredentials(serviceName) {
  try {
    const keytar = require('keytar')
    const credentials = await keytar.findCredentials(serviceName)
    if (credentials && credentials.length > 0) {
      return {
        username: credentials[0].account,
        password: credentials[0].password
      }
    }
  } catch (error) {
    // keytar not available, continue without saved credentials
  }
  return null
}

async function listProviders() {
  const providersDir = join(__dirname, '../providers')
  try {
    const files = await readdir(providersDir)
    const providers = files
      .filter(file => file !== '.gitkeep' && !file.startsWith('.') && file.endsWith('.js'))
      .map(file => file.replace(/\.js$/, ''))
    
    if (providers.length === 0) {
      console.log('No providers available.')
      return
    }
    
    console.log('Available providers:')
    providers.forEach(provider => {
      console.log(`  - ${provider}`)
    })
  } catch (error) {
    console.error('Error reading providers directory:', error.message)
    process.exit(1)
  }
}

;(async function signin() {
  // If no arguments passed, list available providers
  if (process.argv.length <= 2) {
    await listProviders()
    return
  }

  const providerName = process.argv[2]
  
  const { resolve } = require('node:path')
  const providerPath = resolve(__dirname, '../providers', `${providerName}.js`)
  
  try {
    // Load the provider module
    const provider = require(providerPath)
    
    // Get the service name from the provider
    let serviceName = `vps-${providerName}` // default fallback
    if (typeof provider === 'function' && provider.serviceName) {
      serviceName = provider.serviceName
    } else if (provider.serviceName) {
      serviceName = provider.serviceName
    }
    
    // Try to load saved credentials first
    let credentials = await loadCredentials(serviceName)
    
    // If no saved credentials, prompt for them
    if (!credentials) {
      credentials = await promptCredentials(providerName)
      await saveCredentials(serviceName, credentials.username, credentials.password)
    } else {
      console.log(`Using saved credentials for ${providerName}...`)
    }
    
    // Execute the provider's signin function
    if (typeof provider === 'function') {
      await provider(credentials)
    } else if (typeof provider.signin === 'function') {
      await provider.signin(credentials)
    } else {
      console.error(`Provider '${providerName}' does not export a signin function.`)
      process.exit(1)
    }
  } catch (error) {
    if (error.code === 'MODULE_NOT_FOUND') {
      console.error(`Provider '${providerName}' not found.`)
      console.error(`Tried to load: ${providerPath}`)
      console.error(`Error details:`, error.message)
      console.log('\nRun `vps signin` to see available providers.')
      process.exit(1)
    } else {
      console.error(`Error loading provider '${providerName}':`, error.message)
      console.error(error.stack)
      process.exit(1)
    }
  }
})()
