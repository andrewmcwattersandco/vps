#!/usr/bin/env node
// https://github.com/SeleniumHQ/selenium/tree/selenium-4.26.0/javascript/node/selenium-webdriver#usage
// https://github.com/puppeteer/puppeteer/tree/v18.2.1#usage
const { Builder } = require('selenium-webdriver')
const { writeFile } = require('node:fs/promises')
const { readdir } = require('node:fs/promises')
const { join } = require('node:path')

async function listProviders() {
  const providersDir = join(__dirname, '../providers')
  try {
    const files = await readdir(providersDir)
    const providers = files.filter(file => file !== '.gitkeep' && !file.startsWith('.'))
    
    if (providers.length === 0) {
      console.log('No providers available.')
      return
    }
    
    console.log('Available providers:')
    providers.forEach(provider => {
      console.log(`  - ${provider}`)
    })
  } catch (error) {
    console.error('Error reading providers directory:', error.message)
    process.exit(1)
  }
}

;(async function signin() {
  // If no arguments passed, list available providers
  if (process.argv.length <= 2) {
    await listProviders()
    return
  }

  const providerName = process.argv[2]
  const providerPath = join(__dirname, '../providers', providerName)
  
  try {
    // Load the provider module
    const provider = require(providerPath)
    
    // Execute the provider's signin function
    if (typeof provider === 'function') {
      await provider()
    } else if (typeof provider.signin === 'function') {
      await provider.signin()
    } else {
      console.error(`Provider '${providerName}' does not export a signin function.`)
      process.exit(1)
    }
  } catch (error) {
    if (error.code === 'MODULE_NOT_FOUND') {
      console.error(`Provider '${providerName}' not found.`)
      console.log('\nRun `vps signin` to see available providers.')
      process.exit(1)
    } else {
      console.error(`Error loading provider '${providerName}':`, error.message)
      process.exit(1)
    }
  }
})()
